# 微前端技术实现
在本章中，我们将使用第 4 章中讨论的技术方法之一，使用微前端决策框架来构建一个基本的电子商务网站。正如我们所讨论的，当出现以下情况时，没有一种万能的解决方案。 它涉及到建筑。 当我们需要选择一种方法时，项目的目标、组织的结构和沟通以及公司可用的技术技能是我们必须考虑的一些因素。

在确定了我们将在其中运行的环境之后，我们可以使用微前端决策框架来帮助定义我们架构技术方向的关键支柱。 我不会在多个框架中创建相同的示例，而是专注于帮助您构建正确的心智模型，这将使您能够掌握任何微前端框架，而不是只记住一两个可用的选项。

我们肯定会探索一些代码，但我会强调理解为什么做出决定的重要性。 这样，尽管您在下一个项目中使用的方法和框架，您将能够决定正确的方向是什么，而与您对特定微前端框架的熟悉程度无关。

记住一句老话：“授人以鱼，养其一日。 授人以渔，养其一生”？ 让我们学会钓鱼。

##  The Project
我们的项目是一个企业组织的内部 swag 电子商务网站。 该网站由几个子域组成，包括：

* Login
* Payment
* Swag catalog
* Account management
* Employee support
* FAQ

对于本章的示例，我们将只使用其中的三个：身份验证、目录和帐户管理。 电子商务网站必须具有一致的用户界面，以便用户在购买自己喜欢的商品时获得一致的体验。 我们将有几个团队负责交付这个项目。 为了赶上项目的最后期限，技术部门决定重用为其 B2C 电子商务解决方案开发的内部引擎。 这是一个单体后端架构，经过几年的开发和生产环境的强化，已经过实战考验。 但是，技术部门希望摆脱孤立的前端和后端专业知识，因此决定使用微前端并建立独立团队负责新电子商务网站的子域。 它还将使用后端开发人员使用微服务重新架构后端，并在业务和技术层面整合敏捷性。

下一步是分配负责不同子域的团队：

* Sashimi 团队将负责身份验证子域。 由于这是一个内部电子商务网站，团队将使用可用的集中式身份验证系统实施登录表单，员工使用该系统访问组织内的每个系统。 它还将负责帐户详细信息微前端的用户身份验证和个人详细信息。 一名团队成员将成为全栈开发人员，其余成员将专注于与 Microsoft Active Directory (AD) 的后端集成。
* Maki 团队将拥有核心领域——Swag目录。 它是最大的团队，将负责主要的用户体验。 该团队将分为前端开发人员和后端开发人员。
* Nigiri 团队将负责支付子域。 它将集成不同的支付方式，例如信用卡和 PayPal。

我们将实现的流程由三个部分组成。 如图 5-1 所示，认证和目录微前端将是垂直拆分的微前端，而账户管理将由两个水平拆分的微前端组成。 我们可以让一名开发人员在身份验证前端工作，因为实现的较重部分在后端。 然而，对于目录，我们想要更丰富的用户体验，因此我们将拥有一支对前端实践有深入了解的团队。 最后，由于账户管理是不同子域的交集，负责这些子域的两个团队将帮助开发此视图。

遵循微前端决策框架并使用概念证明测试他们的假设，团队决定使用：

*一种识别微前端的混合方法

团队决定对每个子域使用正确的方法，而不是对整个项目使用水平或垂直拆分。 垂直拆分更适合实现认证和目录的业务需求，而账户管理子域的水平拆分则满足了业务需要有多个子域的需求。

*客户端组合

客户端组合支持内部电子商务网站的要求，并且在团队的技能范围内。 这种组合还允许未来向其他平台演进，例如桌面应用程序，甚至是渐进式 Web 应用程序。

*客户端路由

一旦我们决定使用客户端组合，决策框架可以帮助我们轻松地决定路由也应该发生在客户端。 我们还必须考虑到会有两种类型的路由：由微前端容器（也称为应用程序外壳）处理的全局路由，它将负责微前端之间的路由，以及目录内的本地路由 子域，Maki 团队将在其中开发具有多个视图的微前端。


*包含决策框架建议的微前端之间的通信

再次遵循决策框架的建议，团队将使用 Web 存储来共享使用经过身份验证的 API 所需的 JSON Web 令牌 (JWT)。 因为帐户管理视图将有两个微前端并且将来可能会有更多，所以我们希望彼此独立地维护团队和工件。 因此，我们将使用事件发射器在
微前端出现在同一个视图中，预先定义了每个微前端触发的事件和相关的有效负载。


为电子商务网站选择的技术是带有 Module Federation 的 webpack。 经过多次概念验证后，团队认为 Module Federation 将提供成功发布该项目所需的一切。 采用 Module Federation 而不是其他解决方案的主要原因是：

*现有的 webpack 知识

Webpack 在组织内部被广泛使用。 许多开发人员已经将这个 JavaScript 捆绑器用于其他项目，因此他们不必学习新的框架。 Module Federation 非常适合他们的技术堆栈，因为它只是该公司知名工具的插件。

*客户端组合

借助基于客户端的微前端组合，Module Federation 将提供一种简单的方式来异步加载 JavaScript 包。 它最初是为这个特定的用例开发的，然后扩展到服务器端渲染，因此如果将来需求发生变化，团队将能够更改微前端实现，同时保持模块联合作为稳定资产以用于 他们的平台。

*无缝的开发者体验

这些团队在 webpack 方面拥有丰富的专业知识。 同样，自动化管道和本地开发工具中的实施保持不变，因此这是团队立即提高生产力的好方法。

选择模块联盟是出于该项目的特定原因。 对于其他项目，Module Federation 可能是也可能不是正确的选择。 在设计架构时，我们必须在盲目选择技术之前考虑权衡。 在决定哪种微前端架构适合您的用例之前，请分析您的团队结构、开发人员的技能、公司在其他项目中使用的技术堆栈以及项目的业务目标。 在分析了您正在工作的环境之后，使用微前端决策框架为您的项目的未来决策奠定坚实的基础。

##  Module Federation 101

在进入技术实现之前，我们需要了解一些基本概念，以了解一些技术决策背后的推理。 模块联合允许 JavaScript 应用程序动态运行来自另一个包的代码或在客户端和服务器上构建。 它是一个可用于 webpack 5 的插件，在某种程度上也可用于 webpack 4 和 Rollup，但功能有限。 Module Federation 提供了两个关键概念，我们在使用它之前必须了解它们：

*Host

在运行时加载共享库、微前端或组件的容器

*Remote

我们要在主机中加载的 JavaScript 包。正如我们在图 5-2 中看到的，一个主机可以加载多个遥控器。 在我们的例子中，主机代表应用程序外壳，而远程代表微前端。

使用模块联合，共享可以是双向的，允许远程与主机共享部分或整个捆绑包，反之亦然。 但是，双向共享会很快使您的架构复杂化。 最好的方法是单向共享，这样主机就不会与远程共享任何东西。 这使得调试更容易，并且将减少域泄漏到主机的可能性，这可能导致主机和远程之间的设计耦合。

在幕后，Module Federation 编排了两个 webpack 插件：ContainerPlugin 和 ContainerReferencePlugin。 第一个负责创建一个容器以异步加载和同步评估模块，而第二个负责用远程模块覆盖作为占位符创建的容器并使代码充当初始包中的存在。

利用这种架构，我们不仅可以在 webpack 配置中指定远程，还可以在我们的代码中使用 JavaScript 加载它们。 例如，我们可以从 API 中获取路由，并根据用户的国家或角色生成远程的动态视图。

因为 Module Federation 是一个 webpack 插件，所以我们可以使用其他 webpack 能力来优化我们的代码，以最好的方式为我们的
项目。 例如，Module Federation 默认情况下会创建许多 JavaScript 块文件，但我们可能更喜欢远程实现不那么繁琐，只加载两三个文件。 在这种情况下，我们可以使用 MinChunkSizePlugin 强制 webpack 以每个文件的最小千字节对块进行切片。 我们还可以使用 DefinePlugin 在编译时将代码中的变量替换为其他值或表达式。 使用这个插件，当我们在本地测试代码或在我们的开发环境中运行代码时，我们可以轻松地创建一些逻辑来提供正确的基本路径。 结合 webpack 生态系统中可用的其他插件，Module Federation 可以成为一种强大且合适的方式来调整您的输出以适应您的上下文。

同时，前端社区已经开始在他们的项目中采用 Module Federation，并且正在发布新的专用工具以
改善开发人员体验，包括用于了解 Atriom 等远程设备之间共享依赖关系之间关系的仪表板，以及与 Module Federation 结合使用的实时重新加载插件。

我们应该有足够的模块联合知识来深入研究实现细节。 我们在这里探索的项目在一个微前端项目中共享了许多可用于模块联合的配置。 有关详细信息，请查看官方文档。


## 技术实施

既然我们已经回顾了应用程序的开发环境，应用了决策框架并选择了技术策略，现在是时候查看实现细节了。 swag 电子商务存储库在 GitHub 上可用，因此您可以查看整个项目或克隆并使用它。 我特意在没有任何服务器交互的情况下开发了该示例，以便您可以在本地运行它而无需任何外部依赖项。

回顾一下，应用程序由一个在整个用户会话期间可用的应用程序 shell 组成，加载不同的微前端，例如身份验证、目录和帐户管理微前端。 对于技术堆栈，团队选择了带有 webpack 和 Module Federation 的 React，使每个团队都能够创建独立的微前端。 使用模块联合，他们可以共享公共依赖项，并且在用户会话期间只加载一次。 这在不影响开发人员体验的情况下为用户创造了无缝体验。 让我们深入探讨这个应用程序主要部分的关键方面。


### 项目结构





沙箱最主要解决的问题就是全局变量的问题



JS 

`ESM` 不支持，因为无法动态改变执行环境中的模块 `window` 对象，也无法注入新的全局对象 ？


[# 一文带你打通前端沙箱的"任督二脉"](https://juejin.cn/post/7124969690958397471)


## 沙箱的概念


## 沙箱大全


### IIFE

使用作用域的隔离

### evel

沙箱里面执行的环境的所有变量来自沙箱环境，所以需要增加一个上下环境

``` js
// 执行上下文环境
const ctx = {
  func: (v) => {
    console.log(v);
  },
  foo: "foo",
};

function sandbox(code, ctx) {
  eval(code); // 为执行程序构造了一个函数作用域
}

// 待执行程序
const code = `
    ctx.foo = 'bar'
    ctx.func(ctx.foo)
`;

sandbox(code, ctx); // bar
```

### with

`with` 语句可以扩展一个语句的作用域链。`with` 语句是半沙箱模式，`with` 语句将某个对象添加到作用域链的顶部，如果在 `statement` 中有某个未使用命名空间的变量，跟作用域链中的某个属性同名，则这个变量将指向这个属性值。如果沒有同名的属性，则将拋出 `ReferenceError` 异常。


### with + new Function




### with + new Function + proxy

proxy 主要是为了拦截


### 快照沙箱

主要实现原理基于 `diff` 方式，存有两个对象 `windowSnapshot` 保存 `window` 上面的快照信息，`modifyPropsMap` 保存沙箱环境与外部环境不同的快照信息。


### 基于 proxy 的 legacySandbox(单例沙箱)


### 基于 proxy 的 proxySandbox(多例沙箱)


### 天然沙箱 iframe


### 提案 ShadowRealm API

